@model IEnumerable<FlyRemotely.Models.Offer>
@{
    ViewBag.Title = "Moje konto";
    Layout = "~/Views/Shared/_PageLayout.cshtml";
}

@Html.Partial("_PartialManageNav")

<div class="container">
    <div class="row">
        <div class="col-12 col-lg-8 offset-lg-2 o-manage-heading">
            Lista ofert
        </div>
    </div>
</div>

<div class="container">
    @if (Model.Any())
    {
        foreach (var offer in Model)
        {
            <div class="row o-offer-group text-center">
                <div class="col-12 col-lg-2 align-self-center">
                    <span class="o-text-span-bold">Nr. oferty:</span> <br class="o-offer-br">
                    <span class="o-text-span-light">@offer.OfferId</span> <br>
                </div>
                <div class="col-12 col-lg-2 align-self-center">
                    <span class="o-text-span-bold">Tytuł:</span> <br class="o-offer-br">
                    <span class="o-text-span-light">@offer.Title</span> <br>
                </div>
                <div class="col-12 col-lg-2 align-self-center">
                    <span class="o-text-span-bold">Kategoria:</span> <br class="o-offer-br">
                    <span class="o-text-span-light">@offer.Category.Name</span> <br>
                </div>
                <div class="col-12 col-lg-2 align-self-center">
                    <span class="o-text-span-bold">Data:</span> <br class="o-offer-br">
                    <span class="o-text-span-light">@offer.DateAdded.ToString("dd-MM-yyyy")</span>
                </div>
                <div class="col-12 col-lg-2 align-self-center">
                    <span class="o-text-span-bold">Status:</span> <br class="o-offer-br">
                    @if (ViewBag.UserIsAdmin)
                    {
                        using (Html.BeginForm("ChangeOfferStatus", "Manage"))
                        {
                            @Html.HiddenFor(o => offer.OfferId)
                            @Html.EnumDropDownListFor(o => offer.Status, new { @class = "ChangeStatus" })
                        }
                    }
                    else
                    {
                        <span class="o-text-span-light">@offer.Status</span>
                    }
                </div>
                <div class="col-12 col-lg-2 align-self-center">
                    <div class="o-offer-item-btn-div">
                        <a class="o-offer-item-btn" href="@Url.Action("Details", "Catalog", new { offerId = offer.OfferId })">Podgląd</a>
                    </div>
                    @if (ViewBag.UserIsAdmin == false && offer.Status == FlyRemotely.Models.OfferStatus.Nieaktywne)
                    {
                        <div class="o-offer-item-btn-div">
                            <a class="o-offer-item-btn" href="@Url.Action("ChangeOfferStatusUser", "Manage", new { offerId = offer.OfferId, isActive = false })">Aktywuj</a>
                        </div>
                    }
                    else if (ViewBag.UserIsAdmin == false && offer.Status == FlyRemotely.Models.OfferStatus.Aktywne)
                    {
                        <div class="o-offer-item-btn-div">
                            <a class="o-offer-item-btn" href="@Url.Action("ChangeOfferStatusUser", "Manage", new { offerId = offer.OfferId, isActive = true })">Dezaktywuj</a>
                        </div>
                    }
                </div>
            </div>
        }
    }
    else
    {
        <div class="row">
            <div class="col-12 o-offer-empty">
                Brak ofert
            </div>
        </div>
    }
</div>

@section Scripts
{
    <script src="~/Scripts/jquery-3.5.1.js"></script>

    <script>
    $(".ChangeStatus").on('change', function (e) {
        //e.preventDefault();
        var f = $(this.form);
        var div = f.closest("div");
        var action = f.attr("action");
        var serializedForm = f.serialize();
        $.post(action, serializedForm).done(function (data) {
            if (data == '@FlyRemotely.Models.OfferStatus.Oczekuje.ToString()') {
                div.addClass("o-newStatus")
            }
            else {
                div.removeClass("o-newStatus");
            }
          });
    });
    </script>
}